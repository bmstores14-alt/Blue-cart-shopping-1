<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>blue cart shopping</title>
    
    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* CSS കോഡ് നിങ്ങൾ തന്നതുപോലെ തന്നെ, മാറ്റങ്ങൾ ഇല്ല */
        :root {
            --primary-color: #007bff; --secondary-color: #6c757d; --success-color: #28a745;
            --danger-color: #dc3545; --light-color: #f8f9fa; --dark-color: #343a40;
            --background-color: #ffffff; --text-color: #212529; --font-family: 'Poppins', sans-serif;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); --border-radius: 8px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-family); background-color: var(--background-color); color: var(--text-color); padding-top: 60px; padding-bottom: 60px; }
        .page { display: none; }
        .page.active { display: block; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background-color: #fff; padding: 20px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); width: 90%; max-width: 500px; position: relative; max-height: 90vh; overflow-y: auto; }
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 24px; font-weight: bold; cursor: pointer; color: var(--secondary-color); }
        button, .btn { padding: 10px 15px; border: none; background-color: var(--primary-color); color: white; border-radius: 5px; cursor: pointer; font-family: var(--font-family); font-size: 1rem; transition: background-color 0.3s; }
        .btn-danger { background-color: var(--danger-color); }
        .btn-secondary { background-color: var(--secondary-color); }
        input[type="text"], input[type="email"], input[type="password"], textarea, select, input[type="tel"] { width: 100%; padding: 10px; margin: 8px 0; display: inline-block; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-family: var(--font-family); }
        .header { position: fixed; top: 0; left: 0; width: 100%; height: 60px; background-color: #fff; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; box-shadow: var(--box-shadow); z-index: 999; }
        .header .logo { font-size: 1.5rem; font-weight: 600; color: var(--primary-color); }
        .header .header-icons { display: flex; align-items: center; gap: 15px; }
        .header .search-icon { font-size: 1.2rem; cursor: pointer; }
        #login-status-indicator { width: 10px; height: 10px; background-color: var(--success-color); border-radius: 50%; display: none; }
        #login-status-indicator.active { display: block; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background-color: #fff; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 -2px 5px rgba(0,0,0,0.1); z-index: 999; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--secondary-color); text-decoration: none; position: relative; }
        .nav-item.active { color: var(--primary-color); }
        .nav-item i { font-size: 1.5rem; }
        .nav-item span { font-size: 0.7rem; }
        .badge { position: absolute; top: -5px; right: -10px; background-color: var(--danger-color); color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.7rem; display: none; }
        .badge.active { display: block; }
        #home .slider-container { width: 100%; height: 200px; position: relative; overflow: hidden; background: linear-gradient(45deg, #007bff, #00c6ff); margin-bottom: 20px; }
        .slider { display: flex; transition: transform 0.5s ease-in-out; }
        .slide { min-width: 100%; height: 200px; }
        .slide img { width: 100%; height: 100%; object-fit: cover; }
        .slider-nav { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; padding: 10px; cursor: pointer; z-index: 10; }
        .prev-slide { left: 10px; }
        .next-slide { right: 10px; }
        .categories { display: flex; overflow-x: auto; padding: 10px; gap: 15px; -ms-overflow-style: none; scrollbar-width: none; }
        .categories::-webkit-scrollbar { display: none; }
        .category-bubble { display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; width: 80px; flex-shrink: 0; }
        .category-bubble img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid #eee; transition: border-color 0.3s; }
        .category-bubble span { font-size: 0.8rem; font-weight: 500; white-space: nowrap; }
        .category-bubble.active img { border-color: var(--primary-color); transform: scale(1.05); }
        .category-bubble.active span { color: var(--primary-color); }
        .product-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 15px; }
        .product-card { border: 1px solid #eee; border-radius: var(--border-radius); overflow: hidden; text-align: center; box-shadow: var(--box-shadow); cursor: pointer; display: flex; flex-direction: column; justify-content: space-between; }
        .product-card img { width: 100%; height: 150px; object-fit: cover; }
        .product-info { padding: 10px; }
        .product-info h3 { font-size: 0.9rem; margin-bottom: 5px; }
        .product-info .price { color: var(--primary-color); font-weight: 600; }

        /* <<<< മാറ്റം 1: പ്രോഡക്റ്റ് ഫോട്ടോയുടെ വലുപ്പവും തമ്പ്‌നെയിൽ സ്റ്റൈലും >>>>> */
        #product-detail-modal #main-product-image {
            width: 100%;
            height: 220px; /* സ്ഥിരമായ ഉയരം നൽകി */
            object-fit: cover;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
        }
        .product-image-thumbnails {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 2 കോളം ഗ്രിഡ് */
            gap: 8px;
            margin-bottom: 15px;
        }
        .thumbnail-img {
            width: 100%;
            height: 70px;
            object-fit: cover;
            border-radius: var(--border-radius);
            cursor: pointer;
            border: 2px solid #eee;
            transition: border-color 0.3s;
        }
        .thumbnail-img:hover, .thumbnail-img.active {
            border-color: var(--primary-color);
        }

        #auth-modal .form-container { display: none; }
        #auth-modal .form-container.active { display: block; }
        #auth-modal .toggle-link { color: var(--primary-color); text-decoration: underline; cursor: pointer; margin-top: 10px; display: block; }
        #auth-error { color: var(--danger-color); margin-top: 10px; text-align: center; }
        .page-content { padding: 20px; }
        .page-content h1 { margin-bottom: 20px; }
        .cart-item { display: flex; align-items: center; margin-bottom: 15px; padding: 10px; border: 1px solid #eee; border-radius: var(--border-radius); }
        .cart-item img { width: 80px; height: 80px; object-fit: cover; border-radius: var(--border-radius); margin-right: 15px; }
        .item-details { flex-grow: 1; }
        .item-details small { color: var(--secondary-color); display: block; }
        .item-actions { margin-left: auto; }
        .btn-delete-item { padding: 5px 10px; font-size: 1rem; }
        .cart-total { margin-top: 20px; text-align: right; font-size: 1.2rem; font-weight: bold; }
        .checkout-btn { display: block; width: 100%; margin-top: 20px; padding: 15px; font-size: 1.2rem; }
        #cart-container, #wishlist-container, #orders-container { padding: 15px; }
        .order-card { border: 1px solid #ddd; border-radius: var(--border-radius); padding: 15px; margin-bottom: 15px; box-shadow: var(--box-shadow); }
        .order-header { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 10px; }
        .order-status { padding: 5px 10px; border-radius: 15px; color: white; font-size: 0.9rem; text-transform: capitalize; }
        .order-status.payment-verification { background-color: #ffc107; }
        .order-status.confirmed, .order-status.shipped { background-color: var(--primary-color); }
        .order-status.delivered { background-color: var(--success-color); }
        .order-status.cancelled { background-color: var(--danger-color); }
        .profile-details { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .profile-details p { margin: 0; font-size: 1rem; }
        .profile-details p:first-child { color: #6c757d; }
    </style>
</head>
<body>

    <header class="header"><div class="logo">blue cart shopping</div><div class="header-icons"><i class="fas fa-search search-icon"></i><div id="login-status-indicator"></div></div></header>

    <main>
        <section id="home" class="page active">
            <div class="slider-container"><div class="slider"></div><button class="slider-nav prev-slide"><i class="fas fa-chevron-left"></i></button><button class="slider-nav next-slide"><i class="fas fa-chevron-right"></i></button></div>
            <div class="categories"></div>
            <div id="product-grid" class="product-grid"></div>
        </section>
        <section id="search" class="page"><div class="page-content"><input type="text" id="search-input" placeholder="Search..."><div id="search-results-grid" class="product-grid"></div></div></section>
        <section id="cart" class="page"><div class="page-content"><h1>Shopping Cart</h1><div id="cart-container"></div></div></section>
        <section id="orders" class="page"><div class="page-content"><h1>My Orders</h1><div id="orders-container"></div></div></section>
        <section id="profile" class="page"><div class="page-content"><h1>My Profile</h1><div class="profile-details"><p><strong>Email:</strong></p><p id="user-profile-email"></p></div><button id="logout-btn" class="btn btn-danger" style="margin-top: 20px;">Logout</button></div></section>
    </main>

    <footer class="bottom-nav">
        <a href="#home" class="nav-item active"><i class="fas fa-home"></i><span>Home</span></a>
        <a href="#cart" class="nav-item"><i class="fas fa-shopping-cart"></i><span id="cart-badge" class="badge">0</span><span>Cart</span></a>
        <a href="#orders" class="nav-item"><i class="fas fa-box"></i><span>Orders</span></a>
        <a href="#profile" class="nav-item" id="profile-nav-btn"><i class="fas fa-user"></i><span>Profile</span></a>
    </footer>

    <!-- MODALS -->
    <div id="product-detail-modal" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><div id="product-detail-content"></div></div></div>
    <div id="auth-modal" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><div id="login-form-container" class="form-container active"><h2>Login</h2><form id="login-form"><input type="email" id="login-email" placeholder="Email" required><input type="password" id="login-password" placeholder="Password" required><button type="submit">Login</button></form><a class="toggle-link" id="show-register">No account? Register</a></div><div id="register-form-container" class="form-container"><h2>Register</h2><form id="register-form"><input type="email" id="register-email" placeholder="Email" required><input type="password" id="register-password" placeholder="Password (min 6 characters)" required><button type="submit">Register</button></form><a class="toggle-link" id="show-login">Have an account? Login</a></div><div id="auth-error"></div></div></div>
    
    <div id="shipping-modal" class="modal">
        <div class="modal-content">
             <span class="close-btn">&times;</span>
            <h2>Shipping & Payment</h2>
            <form id="shipping-form">
                <input type="text" id="shipping-name" placeholder="Full Name" required>
                <textarea id="shipping-address" placeholder="House Name, Street, Landmark" rows="3" required></textarea>
                <input type="tel" id="shipping-phone" placeholder="Phone Number" pattern="[0-9]{10}" required title="10-digit phone number">
                <input type="text" id="shipping-pincode" placeholder="Pincode" pattern="[0-9]{6}" required title="6-digit pincode">
                <input type="text" id="shipping-state" placeholder="State" required>
                <hr style="margin: 20px 0;">
                <div id="payment-info" style="padding: 10px; border: 1px dashed #ccc; border-radius: 5px; margin-bottom: 20px; background-color: #f8f9fa;">
                    <p style="text-align: center;"><strong>Pay using any UPI App</strong></p>
                    <p style="font-size: 0.9rem; text-align: center;">താഴെയുള്ള ലിങ്കിൽ ക്ലിക്ക് ചെയ്ത് പണമടക്കുക.</p>
                    <button type="button" id="upi-payment-btn" class="btn" style="display: block; text-align: center; margin-top: 10px; width:100%; background-color: #2c3e50;"><i class="fas fa-qrcode"></i> Pay Now: ₹<span id="payment-amount">0.00</span></button>
                    <p style="font-size: 0.8rem; text-align: center; margin-top: 15px;">പണമടച്ചതിന് ശേഷം, ഓർഡർ ഉറപ്പിക്കുന്നതിനായി താഴെയുള്ള ബട്ടൺ അമർത്തുക.</p>
                </div>
                <button type="submit" id="confirm-payment-btn" style="width: 100%; background-color: var(--success-color);"><i class="fas fa-check-circle"></i> I Have Paid, Place My Order</button>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getDatabase, ref, get, set, onValue, remove, push } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // <<<<< പ്രധാനപ്പെട്ടത്: നിങ്ങളുടെ Firebase കോൺഫിഗറേഷൻ ഇവിടെ ചേർക്കുക >>>>>
        const firebaseConfig = {
            apiKey: "AIzaSyA7ujx9787O6yv7TYk4t3SLQlXblL-peTQ",
            authDomain: "kerala-muslim-matrimony-bc096.firebaseapp.com",
            databaseURL: "https://kerala-muslim-matrimony-bc096-default-rtdb.firebaseio.com",
            projectId: "kerala-muslim-matrimony-bc096",
            storageBucket: "kerala-muslim-matrimony-bc096.firebasestorage.app",
            messagingSenderId: "107108283825",
            appId: "1:107108283825:web:6584fd03bdf18266daf990"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        
        let allProducts = [];
        let currentUser = null;
        let userCartRef = null;
        
        const pages = document.querySelectorAll('.page');
        const navItems = document.querySelectorAll('.nav-item');
        const modals = document.querySelectorAll('.modal');
        const searchIcon = document.querySelector('.search-icon');

        const navigateTo = (hash) => {
            const cleanHash = hash.split('?')[0] || '#home';
            const targetPage = document.querySelector(cleanHash);
            pages.forEach(p => p.classList.remove('active'));
            (targetPage || document.querySelector('#home')).classList.add('active');
            navItems.forEach(item => item.classList.toggle('active', item.getAttribute('href') === cleanHash));
        };

        window.addEventListener('hashchange', () => navigateTo(location.hash));
        window.addEventListener('DOMContentLoaded', () => { navigateTo(location.hash); initApp(); });
        
        searchIcon.addEventListener('click', () => location.hash = '#search');
        navItems.forEach(item => { if (item.getAttribute('href')) { item.addEventListener('click', (e) => { e.preventDefault(); location.hash = item.getAttribute('href'); }); } });
        
        document.getElementById('profile-nav-btn').addEventListener('click', (e) => { e.preventDefault(); if (!currentUser) { openModal(document.getElementById('auth-modal')); } else { location.hash = '#profile'; } });
        document.getElementById('logout-btn')?.addEventListener('click', () => signOut(auth));

        const authModal = document.getElementById('auth-modal');
        const loginFormContainer = document.getElementById('login-form-container');
        const registerFormContainer = document.getElementById('register-form-container');
        const authError = document.getElementById('auth-error');
        document.getElementById('show-register').addEventListener('click', () => { loginFormContainer.classList.remove('active'); registerFormContainer.classList.add('active'); authError.textContent = ''; });
        document.getElementById('show-login').addEventListener('click', () => { registerFormContainer.classList.remove('active'); loginFormContainer.classList.add('active'); authError.textContent = ''; });
        
        document.getElementById('login-form').addEventListener('submit', async (e) => { e.preventDefault(); try { await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value); closeModal(authModal); } catch (error) { authError.textContent = error.message; } });
        document.getElementById('register-form').addEventListener('submit', async (e) => { e.preventDefault(); try { await createUserWithEmailAndPassword(auth, document.getElementById('register-email').value, document.getElementById('register-password').value); closeModal(authModal); } catch (error) { authError.textContent = error.message; } });

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            const profileEmailEl = document.getElementById('user-profile-email');
            if (user) {
                document.getElementById('login-status-indicator').classList.add('active');
                userCartRef = ref(db, `users/${user.uid}/cart`);
                if (profileEmailEl) profileEmailEl.textContent = user.email;
                attachFirebaseListeners(); fetchOrders();
            } else {
                document.getElementById('login-status-indicator').classList.remove('active');
                userCartRef = null;
                if (profileEmailEl) profileEmailEl.textContent = '';
                updateCartUI({});
                if (location.hash === '#profile') location.hash = '#home';
            }
        });

        const getProductImage = (product) => (product.imageUrls && product.imageUrls.length > 0) ? product.imageUrls[0] : (product.imageUrl || 'https://via.placeholder.com/150');
        
        const renderProducts = (products, containerId) => { const grid = document.getElementById(containerId); if (grid) grid.innerHTML = products.length ? products.map(p => `<div class="product-card" data-product-id="${p.id}"><img src="${getProductImage(p)}" alt="${p.name}"><div class="product-info"><h3>${p.name}</h3><p class="price">₹${parseFloat(p.price).toFixed(2)}</p></div></div>`).join('') : '<p>No products found.</p>'; };
        
        const updateCartUI = (cart) => {
            const container = document.getElementById('cart-container'); const badge = document.getElementById('cart-badge');
            if (!container || !badge) return;
            if (!cart || Object.keys(cart).length === 0) { container.innerHTML = '<p>Your cart is empty.</p>'; badge.textContent = '0'; badge.classList.remove('active'); return; }
            let totalItems = 0, totalPrice = 0, html = '';
            Object.entries(cart).forEach(([cartItemId, item]) => {
                const product = allProducts.find(p => p.id === item.productId);
                if (product) {
                    const quantity = item.quantity || 1;
                    totalPrice += product.price * quantity; totalItems += quantity;
                    html += `<div class="cart-item" data-cart-item-id="${cartItemId}"><img src="${getProductImage(product)}" alt="${product.name}"><div class="item-details"><h3>${product.name}</h3><p>${quantity} x ₹${product.price}</p><small>Size: ${item.size || 'N/A'}, Color: ${item.color || 'N/A'}</small></div><div class="item-actions"><button class="btn-delete-item btn btn-danger"><i class="fas fa-trash-alt"></i></button></div></div>`;
                }
            });
            html += `<div class="cart-total">Total: ₹${totalPrice.toFixed(2)}</div><button class="checkout-btn">Proceed to Checkout</button>`;
            container.innerHTML = html; badge.textContent = totalItems; badge.classList.add('active');
        };
        
        const fetchOrders = async () => { if (!currentUser) return; onValue(ref(db, `orders/${currentUser.uid}`), (s) => { const c = document.getElementById('orders-container'); if (s.exists()) { c.innerHTML = Object.values(s.val()).sort((a,b) => b.date - a.date).map(o => `<div class="order-card"><div class="order-header"><span>Order ID: ${o.orderId.slice(-8)}</span><span>${new Date(o.date).toLocaleDateString()}</span></div><p>Total: ₹${o.totalAmount.toFixed(2)}</p><p>Status: <span class="order-status ${o.status.replace(' ', '-').toLowerCase()}">${o.status}</span></p></div>`).join(''); } else { c.innerHTML = '<p>You have no orders yet.</p>'; } }); };
        
        const initApp = async () => {
            try {
                const productsSnapshot = await get(ref(db, 'products'));
                if (productsSnapshot.exists()) {
                    allProducts = Object.entries(productsSnapshot.val()).map(([id, data]) => ({ id, ...data }));
                    renderProducts(allProducts, 'product-grid');
                    renderCategories(allProducts);
                }
                const sliderSnapshot = await get(ref(db, 'sliderImages'));
                renderSlider(sliderSnapshot.exists() ? Object.values(sliderSnapshot.val()) : []);
            } catch (error) { console.error("Initialization error:", error); }
        };

        const renderSlider = (sliderImages) => {
            const slider = document.querySelector('#home .slider');
            if (sliderImages && sliderImages.length > 0) {
                slider.innerHTML = sliderImages.map(img => `<div class="slide"><img src="${img.downloadURL}" alt="Slider Image"></div>`).join('');
                initSlider();
            } else {
                slider.innerHTML = `<div class="slide"><h2>blue cart</h2></div>`;
                document.querySelectorAll('.slider-nav').forEach(nav => nav.style.display = 'none');
            }
        };

        let currentSlide = 0; let slideInterval;
        const initSlider = () => {
            const slides = document.querySelectorAll('#home .slide'); if(slides.length <= 1) return;
            const slider = document.querySelector('#home .slider');
            const next = () => { currentSlide = (currentSlide + 1) % slides.length; slider.style.transform = `translateX(-${currentSlide * 100}%)`; };
            document.querySelector('.next-slide').addEventListener('click', next);
            document.querySelector('.prev-slide').addEventListener('click', () => { currentSlide = (currentSlide - 1 + slides.length) % slides.length; slider.style.transform = `translateX(-${currentSlide * 100}%)`; });
            slideInterval = setInterval(next, 3000);
        };

        const renderCategories = (products) => {
            const container = document.querySelector('.categories'); if(!container) return;
            const categoryInfo = products.reduce((acc, p) => { if (p.category && !acc[p.category]) acc[p.category] = getProductImage(p); return acc; }, {});
            const toRender = [{ name: 'All', image: 'https://img.icons8.com/ios-filled/100/CCCCCC/check-all.png' }, ...Object.entries(categoryInfo).map(([name, image]) => ({ name, image }))];
            container.innerHTML = toRender.map(cat => `<div class="category-bubble" data-category="${cat.name}"><img src="${cat.image}" alt="${cat.name}"><span>${cat.name}</span></div>`).join('');
            container.querySelector('.category-bubble')?.classList.add('active');
            container.addEventListener('click', e => {
                const bubble = e.target.closest('.category-bubble');
                if (bubble) {
                    container.querySelectorAll('.category-bubble').forEach(b => b.classList.remove('active'));
                    bubble.classList.add('active');
                    filterProducts(bubble.dataset.category);
                }
            });
        };
        
        const attachFirebaseListeners = () => { if (userCartRef) onValue(userCartRef, s => updateCartUI(s.val() || {})); };
        const filterProducts = (category) => { const filtered = category === 'All' ? allProducts : allProducts.filter(p => p.category === category); renderProducts(filtered, 'product-grid'); };
        const openModal = (modal) => modal.classList.add('active');
        const closeModal = (modal) => modal.classList.remove('active');
        
        modals.forEach(modal => modal.addEventListener('click', e => { if (e.target === modal || e.target.classList.contains('close-btn')) closeModal(modal); }));

        document.body.addEventListener('click', e => {
            if (e.target.closest('.product-card')) { openProductDetailModal(e.target.closest('.product-card').dataset.productId); }
            if (e.target.classList.contains('checkout-btn')) { if(!currentUser) { openModal(document.getElementById('auth-modal')); return; } openShippingModal(); }
            if (e.target.id === 'modal-add-to-cart-btn') {
                const productId = e.target.dataset.productId;
                const color = document.getElementById('modal-color-select')?.value || null;
                const size = document.getElementById('modal-size-select')?.value || null;
                handleAddToCart(productId, 1, color, size);
                closeModal(document.getElementById('product-detail-modal'));
            }
            const cartItem = e.target.closest('.cart-item');
            if (cartItem && e.target.closest('.btn-delete-item')) { handleRemoveFromCart(cartItem.dataset.cartItemId); }
        });

        const handleAddToCart = async (productId, quantity, color, size) => { if (!currentUser) { openModal(document.getElementById('auth-modal')); return; } const newCartItemRef = push(userCartRef); await set(newCartItemRef, { productId, quantity, color, size }); alert('Product added to cart!'); };
        const handleRemoveFromCart = (cartItemId) => { if (!currentUser || !userCartRef) return; const itemRef = ref(db, `users/${currentUser.uid}/cart/${cartItemId}`); remove(itemRef); };

        // <<<< മാറ്റം 2: ഫോട്ടോയിൽ ക്ലിക്ക് ചെയ്യുമ്പോൾ മാറാനുള്ള ലോജിക് ചേർത്തു >>>>>
        const openProductDetailModal = (productId) => {
            const product = allProducts.find(p => p.id === productId); if (!product) return;
            const content = document.getElementById('product-detail-content');
            const images = product.imageUrls || [];
            const mainImg = images.length > 0 ? images[0] : getProductImage(product);
            
            const thumbsHtml = images.length > 1 
                ? images.map((url, i) => `<img src="${url}" class="thumbnail-img ${i === 0 ? 'active' : ''}" alt="thumbnail ${i+1}">`).join('')
                : '';
            
            const colors = (product.colors && product.colors.length > 0) ? `<select id="modal-color-select"><option value="">Select Color</option>${product.colors.map(c => `<option value="${c}">${c}</option>`).join('')}</select>` : '';
            const sizes = (product.sizes && product.sizes.length > 0) ? `<select id="modal-size-select"><option value="">Select Size</option>${product.sizes.map(s => `<option value="${s}">${s}</option>`).join('')}</select>` : '';
            
            content.innerHTML = `
                <img src="${mainImg}" alt="${product.name}" id="main-product-image">
                <div class="product-image-thumbnails">${thumbsHtml}</div>
                <h2>${product.name}</h2>
                <p class="price">₹${parseFloat(product.price).toFixed(2)}</p>
                <p>${product.description || ''}</p>
                ${sizes}
                ${colors}
                <button class="btn" style="width:100%" id="modal-add-to-cart-btn" data-product-id="${product.id}">Add to Cart</button>`;
            
            if (images.length > 1) {
                const mainImageEl = document.getElementById('main-product-image');
                const thumbnails = content.querySelectorAll('.thumbnail-img');
                thumbnails.forEach(thumb => {
                    thumb.addEventListener('click', () => {
                        mainImageEl.src = thumb.src;
                        thumbnails.forEach(t => t.classList.remove('active'));
                        thumb.classList.add('active');
                    });
                });
            }

            openModal(document.getElementById('product-detail-modal'));
        };

        const openShippingModal = async () => {
            if (!userCartRef) return;
            const snapshot = await get(userCartRef); const cart = snapshot.val(); if (!cart) { alert("Your cart is empty!"); return; }
            let totalAmount = 0;
            for (const item of Object.values(cart)) { const product = allProducts.find(p => p.id === item.productId); if (product) totalAmount += product.price * (item.quantity || 1); }
            if (totalAmount <= 0) { alert("Could not calculate total."); return; }
            
            const upiId = "bmfurniture@ibl";
            const merchantName = "blue cart shopping";
            
            const upiLink = `upi://pay?pa=${upiId}&pn=${encodeURIComponent(merchantName)}&am=${totalAmount.toFixed(2)}&cu=INR&tn=OrderPayment`;
            
            document.getElementById('payment-amount').textContent = totalAmount.toFixed(2);
            const upiPayBtn = document.getElementById('upi-payment-btn');
            upiPayBtn.onclick = () => { window.location.href = upiLink; };
            
            openModal(document.getElementById('shipping-modal'));
        };

        document.getElementById('shipping-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser || !e.target.checkValidity()) { e.target.reportValidity(); return; }
            try {
                const cartSnapshot = await get(userCartRef); const cart = cartSnapshot.val(); if (!cart) { alert("Your cart is empty."); return; }
                const shippingDetails = {
                    shippingName: document.getElementById('shipping-name').value, shippingAddress: document.getElementById('shipping-address').value,
                    shippingPhone: document.getElementById('shipping-phone').value, shippingPincode: document.getElementById('shipping-pincode').value,
                    shippingState: document.getElementById('shipping-state').value,
                };
                let totalAmount = 0; const items = [];
                for (const cartItem of Object.values(cart)) {
                    const product = allProducts.find(p => p.id === cartItem.productId);
                    if (product) {
                        totalAmount += product.price * (cartItem.quantity || 1);
                        items.push({
                            productId: cartItem.productId, name: product.name, quantity: (cartItem.quantity || 1), price: product.price,
                            imageUrl: getProductImage(product), size: cartItem.size || 'N/A', color: cartItem.color || 'N/A'
                        });
                    }
                }
                const newOrderRef = push(ref(db, `orders/${currentUser.uid}`));
                await set(newOrderRef, {
                    orderId: newOrderRef.key, date: Date.now(), userEmail: currentUser.email, items: items,
                    totalAmount: totalAmount, paymentMethod: 'UPI', status: 'Payment Verification', ...shippingDetails
                });
                await remove(userCartRef);
                closeModal(document.getElementById('shipping-modal'));
                alert("Thank you! Your order has been placed. We will confirm it after verifying your payment.");
                location.hash = '#orders';
            } catch (error) { console.error("Order error:", error); alert("Failed to place order."); }
        });
    </script>
</body>
</html>